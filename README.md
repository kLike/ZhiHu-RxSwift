# å å…¥é“¾å¼ç¼–ç¨‹çš„å¹»ä¹é‡Œ--ç”¨RxSwiftä»¿å†™çŸ¥ä¹æ—¥æŠ¥

ç”¨è¿‡æ— æ•°çš„ä¸‰æ–¹åº“ï¼Œå´ä»æ—§å†™ä¸å¥½ä»£ç ã€‚ä»¥å‰æ€»ä¼šæœ‰äººé—®ï¼šä½ ç”¨è¿‡æœ€å¥½çš„ä¸‰æ–¹åº“æ˜¯ä»€ä¹ˆï¼Ÿé‚£ä¸ªæ—¶å€™æ€»æ˜¯ä¼šçŠ¹è±«åŠå¤©ï¼Œåˆ°åº•æ˜¯å“ªä¸€ä¸ªå‘¢ï¼Ÿå¥½åƒéƒ½è¿˜å¯ä»¥è€¶ï¼Œç›´åˆ°åæ¥é‡åˆ°[RxSwift](https://github.com/ReactiveX/RxSwift)ï¼Œå“‡ï¼Œç®€ç›´æ‰“å¼€äº†æ–°ä¸–ç•Œçš„å¤§é—¨ã€‚ç°åœ¨æˆ‘ä¼šæ¯«ä¸çŠ¹è±«æ¨èå®ƒï¼Œè™½ç„¶å­¦ä¹ æ›²çº¿æœ‰ç‚¹é™¡å³­ï¼Œä½†æ˜¯ä¸€æ—¦ä½ ä¹ æƒ¯ä¸Šå®ƒï¼Œå¿…æ·±é™·äºå…¶ä¸­æ— æ³•è‡ªæ‹”ã€‚

###åˆå…¥RxSwift

åœ¨å…¬å¸é¡¹ç›®è¿›å…¥ç‰ˆæœ¬è¿­ä»£çš„æ—¶æœŸï¼Œæ€»è§‰å¾—åº”è¯¥å­¦ç‚¹ä»€ä¹ˆï¼Œä¸ç„¶è®©æ‹åœ¨æ²™æ»©ä¸Šæ€ä¹ˆåŠï¼Ÿåœ¨å­¦ä¹ swift3ä¸€æ®µæ—¶é—´åï¼Œé‚‚é€…äº†å“åº”å¼ç¼–ç¨‹æ–¹å¼ï¼Œçœ‹äº†ä¸€ä¸‹ç›¸å…³æ–‡ç« ï¼Œæ¯«ä¸çŠ¹è±«è·³å…¥RxSwiftçš„å‘ä¸­ï¼Œå…¶ä¸­é™©äº›æ”¾å¼ƒï¼Œè¿˜å¥½åšæŒä¸‹æ¥äº†ï¼Œç°åœ¨ä¹Ÿç®—å…¥äº†ä¸ªé—¨ã€‚å½“ç„¶åªçœ‹çœ‹ç†è®ºçŸ¥è¯†ç‚¹ï¼Œå…‰çº¸ä¸Šè°ˆå…µæ˜¯ä¸è¡Œçš„ï¼Œæ‰€ä»¥é€‰æ‹©ä»¿å†™çŸ¥æ—¥æŠ¥çš„æ–¹å¼æ¥æ·±åŒ–ä¸€ä¸‹çŸ¥è¯†ã€‚

- å¦‚æœä½ ä¸ç†Ÿæ‚‰RxSwiftç›¸å…³çš„çŸ¥è¯†ï¼Œå¯ä»¥å…ˆçœ‹çœ‹å®˜æ–¹æ–‡æ¡£
[RxSwift](https://github.com/ReactiveX/RxSwift)
- å¦‚æœä½ ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦ä½¿ç”¨RxSwiftï¼Œå¯ä»¥çœ‹çœ‹
[why use rx?](https://github.com/ReactiveX/RxSwift/blob/master/Documentation/Why.md)
- å¦‚æœä½ æƒ³å…¥å‘ï¼Œæ¨èå®˜æ–¹çš„demoï¼Œä¹Ÿå¯ä»¥åœ¨ç®€ä¹¦ä¸Šæœç´¢ç›¸å…³æ–‡ç« ï¼Œæ¨èå‡ ç¯‡æ–‡ç« ï¼š
[ä½¿ç”¨ RxSwift è¿›è¡Œå“åº”å¼ç¼–ç¨‹](https://realm.io/cn/news/altconf-scott-gardner-reactive-programming-with-rxswift/)ï¼Œ
[Getting Started With RxSwift and RxCocoa](http://southpeak.github.io/2017/01/16/Getting-Started-With-RxSwift-and-RxCocoa/)ï¼Œ
[RxSwift å…¥å‘æ‰‹å†Œ Part1 - ç¤ºä¾‹å®æˆ˜](http://blog.callmewhy.com/2015/09/23/rxswift-getting-started-1/)

###é¡¹ç›®å®æˆ˜

æ•´ä¸ªé¡¹ç›®æŒç»­çš„å¤§æ¦‚ä¸¤å‘¨ï¼Œé‡åˆ°ä¸å°‘é—®é¢˜ï¼Œæ¯•ç«Ÿä¸ç®¡å¯¹äºSwiftè¿˜æ˜¯RxSwiftæ¥è¯´ï¼Œæˆ‘å¤§æ¦‚éƒ½åªæ˜¯ä¸ªæ–°æ‰‹ã€‚

####ç½‘ç»œè¯·æ±‚ Moya + RxSwift

- [API](https://github.com/izzyleung/ZhihuDailyPurify/wiki/çŸ¥ä¹æ—¥æŠ¥-API-åˆ†æ): é¡¹ç›®çš„å¼€å§‹å½“ç„¶æ˜¯çœ‹çœ‹æœ‰æ²¡æœ‰APIå‘€ï¼Œè¿™é‡Œè¦æ„Ÿè°¢è¿™ä½é€šè¿‡éæ­£å¸¸æ‰‹æ®µè·å–APIçš„åŒå­¦ï¼Œä¸ºæˆ‘ä»¬æ€»ç»“äº†å®Œæ•´çš„[çŸ¥ä¹æ—¥æŠ¥-API-åˆ†æ](https://github.com/izzyleung/ZhihuDailyPurify/wiki/çŸ¥ä¹æ—¥æŠ¥-API-åˆ†æ)ï¼Œæˆ‘ä¹Ÿæ— ç§åœ°å¥‰çŒ®äº†starï¼Œç•¥è¡¨æ„Ÿè°¢ï¼
- [Alamofire](https://github.com/Alamofire/Alamofire): Swiftç‰ˆçš„AFNetworkingã€‚
- [Moya](https://github.com/Moya/Moya): æ˜¯ Artsy å›¢é˜Ÿçš„ Ash Furrow ä¸»å¯¼å¼€å‘çš„ä¸€ä¸ªç½‘ç»œæŠ½è±¡å±‚åº“ã€‚å®ƒåœ¨ Alamofire åŸºç¡€ä¸Šæä¾›äº†ä¸€ç³»åˆ—ç®€å•çš„æŠ½è±¡æ¥å£ï¼Œè®©å®¢æˆ·ç«¯ä»£ç ä¸ç”¨å»ç›´æ¥è°ƒç”¨ Alamofireï¼Œä¹Ÿä¸ç”¨å»å…³å¿ƒ NSURLSessionã€‚åŒæ—¶æä¾›äº†å¾ˆå¤šå®ç”¨çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¯¹RxSwiftçš„è‰¯å¥½æ‰©å±•ã€‚
- [HandyJSON](https://github.com/alibaba/HandyJSON): æ˜¯ä¸€ä¸ªç”¨äºSwiftè¯­è¨€ä¸­çš„JSONåºåˆ—åŒ–/ååºåˆ—åŒ–åº“ã€‚ä¸å…¶ä»–æµè¡Œçš„Swift JSONåº“ç›¸æ¯”ï¼ŒHandyJSONçš„ç‰¹ç‚¹æ˜¯ï¼Œå®ƒæ”¯æŒçº¯swiftç±»ï¼Œä½¿ç”¨ä¹Ÿç®€å•ã€‚å®ƒååºåˆ—åŒ–æ—¶(æŠŠJSONè½¬æ¢ä¸ºModel)ä¸è¦æ±‚Modelä»NSObjectç»§æ‰¿(å› ä¸ºå®ƒä¸æ˜¯åŸºäºKVCæœºåˆ¶)ï¼Œä¹Ÿä¸è¦æ±‚ä½ ä¸ºModelå®šä¹‰ä¸€ä¸ªMappingå‡½æ•°ã€‚åªè¦ä½ å®šä¹‰å¥½Modelç±»ï¼Œå£°æ˜å®ƒæœä»HandyJSONåè®®ï¼ŒHandyJSONå°±èƒ½è‡ªè¡Œä»¥å„ä¸ªå±æ€§çš„å±æ€§åä¸ºKeyï¼Œä»JSONä¸²ä¸­è§£æå€¼ã€‚HandyJSONç›®å‰ä¾èµ–äºä»Swift Runtimeæºç ä¸­æ¨æ–­çš„å†…å­˜è§„åˆ™ï¼Œä»»ä½•å˜åŠ¨æˆ‘ä»¬å°†éšæ—¶è·Ÿè¿›ã€‚
- [RxSwift](https://github.com/ReactiveX/RxSwift): å“åº”å¼ç¼–ç¨‹ä¸‰æ–¹åº“ã€‚è¿™é‡Œä¸»è¦å¤„ç†ç½‘ç»œè¯·æ±‚æ—¶çš„å„ç§å›è°ƒå’Œå¼‚æ­¥çº¿ç¨‹ã€‚

æœ€ç»ˆå®ç°æ•ˆæœï¼š
```
let provider = RxMoyaProvider<ApiManager>()
provider                                      //moyaç½‘ç»œè¯·æ±‚çš„manager
    .request(.getNewsList)                    //å„ç§è¯·æ±‚ä»¥æšä¸¾çš„å½¢å¼è°ƒç”¨
    .mapModel(listModel.self)                 //JOSN->Model
    .subscribe(onNext: { (model) in
        print(model)                          //è¯·æ±‚æ•°æ®å›è°ƒï¼Œå¤„ç†æ•°æ®
    })
    .addDisposableTo(dispose)                 //èµ„æºå›æ”¶
```
APIæšä¸¾ï¼š
```
enum ApiManager {
    case getLaunchImg
    case getNewsList
    case getMoreNews(String)
    case getThemeList
    case getThemeDesc(Int)
    case getNewsDesc(Int)
}
```
ç”±äºMoyaæ²¡æœ‰æ”¯æŒHandyJSONæ‰©å±•ï¼Œè¿™é‡Œæˆ‘è‡ªå·±å®ç°äº†æ­¤æ‰©å±•ï¼š
```
extension ObservableType where E == Response {
    public func mapModel<T: HandyJSON>(_ type: T.Type) -> Observable<T> {
        return flatMap { response -> Observable<T> in
            return Observable.just(response.mapModel(T.self))
        }
    }
}

extension Response {
    func mapModel<T: HandyJSON>(_ type: T.Type) -> T {
        let jsonString = String.init(data: data, encoding: .utf8)
        return JSONDeserializer<T>.deserializeFrom(json: jsonString)!
    }
}
```
åªè¦Modeléµå¾ªHandyJSONåè®®ï¼Œå°±èƒ½å¾ˆä¼˜é›…çš„å¿«é€Ÿå®ç°JSON->Modelï¼ŒåŒ…æ‹¬åµŒå¥—è§£æï¼š
```
struct listModel: HandyJSON {
    var date: String?
    var stories: [storyModel]?
    var top_stories: [storyModel]?
}

struct storyModel: HandyJSON {
    var ga_prefix: String?
    var id: Int?
    var images: [String]? //list_stories
    var title: String?
    var type: Int?
    var image: String? //top_stories
    var multipic = false
}
```
å¯ä»¥è¯´ï¼Œè¿™æ˜¯è¿„ä»Šä¸ºæ­¢æˆ‘æœ€æ»¡æ„çš„ç½‘ç»œè¯·æ±‚å°è£…ï¼Œä»¥åéƒ½å¯ä»¥æ„‰å¿«å¤„ç†è¯·æ±‚å•¦ğŸ˜


####æ•°æ®å‘ˆç°

æ•°æ®è¯·æ±‚å¤„ç†å¥½äº†ï¼Œå°±è¯¥ç»‘å®šè§†å›¾æ˜¾ç¤ºå‡ºæ¥äº†ï¼Œè¿™é‡Œå°±æ˜¯RxSwiftçš„æ‹¿æ‰‹å¥½æˆäº†ã€‚ä¸‹é¢æˆ‘ä»¬å…ˆçœ‹æœ€ç®€å•çš„å±•ç°ï¼š

```
    let provider = RxMoyaProvider<ApiManager>()
    let dispose = DisposeBag()
    let themeArr = Variable([ThemeModel]())
        
        //è¯·æ±‚æ•°æ®
        provider
            .request(.getThemeList)
            .mapModel(ThemeResponseModel.self)
            .subscribe(onNext: { (model) in
                self.themeArr.value = model.others!
            })
            .addDisposableTo(dispose)
        
        //ç»‘å®šè§†å›¾
        themeArr
            .asObservable()
            .bindTo(tableView.rx.items(cellIdentifier: "ThemeTableViewCell", cellType: ThemeTableViewCell.self)) {
                row, model, cell in
                cell.name.text = model.name
                cell.homeIcon.isHidden = row == 0 ? false : true
                cell.nameLeft.constant = row == 0 ? 50 : 15
        }
            .addDisposableTo(dispose)
      
       //å“åº”è§†å›¾   
        tableView.rx
            .modelSelected(ThemeModel.self)
            .subscribe(onNext: { (model) in
                self.showView = false
                self.showThemeVC(model)
            })
            .addDisposableTo(dispose)
```
è¿™æ ·ç®€å•çš„å‡ è¡Œä»£ç å°±å®Œæˆç½‘ç»œè¯·æ±‚æ•°æ®å±•ç°ä»¥åŠç”¨æˆ·å“åº”ä¸€ç³»åˆ—æµç¨‹ï¼Œä»€ä¹ˆä»£ç†ï¼Œæ‰©å±•éƒ½ä¸ç”¨å†™äº†ï¼Œå‡å°‘äº†ä¸€åŠä»¥ä¸Šçš„ä»£ç ï¼Œæ˜¯ä¸æ˜¯çœ‹ç€å°±è§‰å¾—çˆ½ç‚¸äº†ï¼æˆ‘ä»¬å†çœ‹çœ‹å¤æ‚ä¸€ç‚¹çš„ï¼Œåˆ†ç»„tableviewï¼š
```
        let dataSource = RxTableViewSectionedReloadDataSource<SectionModel<String, storyModel>>()
        let dispose = DisposeBag()

        dataSource.configureCell = { (dataSource, tv, indexPath, model) in
            let cell = tv.dequeueReusableCell(withIdentifier: "ListTableViewCell") as! ListTableViewCell
            cell.title.text = model.title
            cell.img.kf.setImage(with: URL.init(string: (model.images?.first)!))
            cell.morepicImg.isHidden = !model.multipic
            return cell
        }
        
        dataArr
            .asObservable()
            .bindTo(tableView.rx.items(dataSource: dataSource))
            .addDisposableTo(dispose)
        
        tableView.rx
            .modelSelected(storyModel.self)
            .subscribe(onNext: { (model) in
                self.tableView.deselectRow(at: self.tableView.indexPathForSelectedRow!, animated: true)
                let detailVc = DetailViewController()
                detailVc.id = model.id!
                self.navigationController?.pushViewController(detailVc, animated: true)
            })
            .addDisposableTo(dispose)
```
å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯éœ€è¦ç»‘å®šSectionModelï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰SectionModelæ¥åˆ†ç»„å±•ç¤ºï¼Œä¸Šé¢çš„ä»£ç éƒ½åœ¨é¡¹ç›®ç­›é€‰å‡ºæ¥çš„ï¼Œå…·ä½“å®ç°å¯ä»¥çœ‹æ–‡æœ«é¡¹ç›®é“¾æ¥ã€‚

###é¡¹ç›®éš¾ç‚¹

####1. èœå•æ ä¸ä¸»é¡µé¢çš„åˆ‡æ¢



![menuShow.gif](https://github.com/kLike/ZhiHu-RxSwift/blob/master/ZhiHu%2BRxSwift/menuShow.gif)

ç”±äºå¯¼èˆªæ ä¸€å¼€å§‹ç”¨çš„åŸç”Ÿçš„ï¼ˆå…¶å®åº”è¯¥è‡ªå®šä¹‰ï¼Œå› ä¸ºåé¢æ¶‰åŠåˆ°å¾ˆå¤šå¯¼èˆªæ é—®é¢˜ï¼‰ï¼Œæ‰€ä»¥å·¦å³å¹³ç§»çš„æ—¶å€™è¦æŠŠå¯¼èˆªæ ä¸€èµ·ç§»åŠ¨ï¼Œæ‰€ä»¥é‡åˆ°äº†ä¸€ç‚¹é—®é¢˜ï¼Œåæ¥æŸ¥æ‰¾ç›¸å…³èµ„æ–™åè§£å†³äº†æ­¤é—®é¢˜ï¼š

```
    func showMenu() {
        let view = UIApplication.shared.keyWindow?.subviews.first
        let menuView = UIApplication.shared.keyWindow?.subviews.last
        UIApplication.shared.keyWindow?.bringSubview(toFront: (UIApplication.shared.keyWindow?.subviews[1])!)
        UIView.animate(withDuration: 0.5, animations: { 
            view?.transform = CGAffineTransform.init(translationX: 225, y: 0)
            menuView?.transform = (view?.transform)!
        })
    }
    
    func dismissMenu() {
        let view = UIApplication.shared.keyWindow?.subviews.first
        let menuView = UIApplication.shared.keyWindow?.subviews.last
        UIApplication.shared.keyWindow?.bringSubview(toFront: (UIApplication.shared.keyWindow?.subviews[1])!)
        UIView.animate(withDuration: 0.5, animations: {
            view?.transform = CGAffineTransform.init(translationX: 0, y: 0)
            menuView?.transform = (view?.transform)!
        })
    }
```
èœå•æ çš„æ˜¾ç¤ºå’Œéšè—éœ€è¦é…åˆæ‰‹åŠ¿ï¼Œç ”ç©¶å®˜æ–¹çŸ¥ä¹æ—¥æŠ¥Appåï¼Œå‘ç°å­˜åœ¨è½»æ‰«å’Œæ‹–æ‹½æ»‘åŠ¨ä¸¤ä¸ªæ‰‹åŠ¿ï¼Œç›¸å¯¹åº”UIPanGestureRecognizerå’ŒUISwipeGestureRecognizerï¼Œå½“æŠŠè¿™ä¸¤ä¸ªè§†å›¾åˆ†åˆ«åŠ åœ¨è§†å›¾ä¸Šçš„æ—¶å€™ï¼Œåªä¼šå“åº”ä¸€ä¸ªæ‰‹åŠ¿ï¼Œåæ¥è®¾ç½®UIGestureRecognizerDelegateåé¿å…äº†è¿™ä¸ªé—®é¢˜ï¼š
```
extension HomeViewController: UIGestureRecognizerDelegate {
    //æ˜¯å¦å…è®¸æ‰‹åŠ¿è¯†åˆ«å™¨åŒæ—¶è¯†åˆ«ä¸¤ä¸ªæ‰‹åŠ¿
    func gestureRecognizer(_ gestureRecognizer: UIGestureRecognizer, shouldRecognizeSimultaneouslyWith otherGestureRecognizer: UIGestureRecognizer) -> Bool {
        return true
    }
}
```
æœ¬ä»¥ä¸ºå°±æ­¤è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯å®é™…æ“ä½œèµ·æ¥ï¼Œæ‰‹æœºå¾ˆéš¾åŒºåˆ†è¿™ä¸ªä¸¤ä¸ªæ‰‹åŠ¿ï¼Œç»å¸¸ä¼šæé”™ï¼Œæœ¬æ¥æƒ³æ‹–æ‹½æ»‘åŠ¨ç»“æœç³»ç»Ÿè¯†åˆ«ä¸ºäº†è½»æ‰«æ‰‹åŠ¿ï¼Œä½“éªŒæ•ˆæœå¾ˆå·®ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿåæ¥ç»ˆäºæ‰¾åˆ°ä¸€ç§å¯è¡Œæ–¹æ¡ˆï¼š**åªåœ¨è§†å›¾ä¸Šæ·»åŠ UIPanGestureRecognizerï¼Œä»¥æ‰‹æŒ‡æ“ä½œæ—¶é—´æ¥åŒºåˆ†æ˜¯è½»æ‰«è¿˜æ˜¯æ‹–æ‹½æ»‘åŠ¨**
```
    func panGesture(pan: UIPanGestureRecognizer) {
        let xoff = pan.translation(in: view).x
        if pan.state == .began {
            beganDate = Date()
        }
        if pan.state == .ended {
            endDate = Date()
            //åŒºåˆ†æ˜¯è½»æ‰«è¿˜æ˜¯æ»‘åŠ¨
            if endDate! < beganDate! + 150000000.nanoseconds {
                if xoff > 0 {
                    showView = true
                } else {
                    showView = false
                }
                return
            }
        }
        //æ»‘åŠ¨èŒƒå›´ä»¥åŠæ»‘åŠ¨ç»“æŸåéœ€è¦showè¿˜æ˜¯dismiss
        if (0 < xoff && xoff <= 225 && !showView) || (0 > xoff && xoff >= -225 && showView) {
            if pan.translation(in: view).x > 0 {
                moveMenu(pan.translation(in: view).x)
            } else {
                moveMenu(225 + pan.translation(in: view).x)
            }
            if pan.state == .ended {
                if showView {
                    if pan.translation(in: view).x < -175 {
                        showView = false
                    } else {
                        showView = true
                    }
                } else {
                    if pan.translation(in: view).x > 50 {
                        showView = true
                    } else {
                        showView = false
                    }
                }
            }
        }
    }
```
èœå•æ ä¸ä¸»é¡µé¢çš„åˆ‡æ¢ä¸­è¿˜æœ‰ä¸€ä¸ªä¸å¥½å¤„ç†çš„ç‚¹ï¼Œå½“é€‰ä¸­èœå•æ æŸä¸ªä¸»é¢˜åï¼Œè¦æ¨å‡ºä¸€ä¸ªä¸»é¢˜æ—¥æŠ¥åˆ—è¡¨ï¼Œä¸é¦–é¡µä¸åŒå±äºä¸€ä¸ªUINavigationControllerï¼Œé‚£æ€ä¹ˆä»ä¸€ä¸ªUINavigationControlleråˆ°å¦ä¸€ä¸ªUINavigationControllerå‘¢ï¼Ÿè¯•äº†å¥½å‡ ç§æ–¹å¼æ¥åˆ‡æ¢ï¼Œå§‹ç»ˆè¾¾ä¸åˆ°å®˜æ–¹æ•ˆæœï¼Œå¿™ç¢Œäº†ä¸€å¤©ï¼Œæœ€åçµå…‰ä¸€ç°ï¼ˆä¹Ÿå¯èƒ½æ˜¯æˆ‘å¤ªè ¢ğŸ˜«ï¼‰å¹³å¸¸ä¸æ˜¯éƒ½ç”¨UITabBarControlleræ¥åˆ‡æ¢UINavigationControllerï¼Ÿï¼çœŸçš„å¥½ç®€å•ï¼Œéšè—æ‰tabbarå°±å¥½ï¼Œå‡ å¥ä»£ç å°±å®Œç¾è§£å†³äº†è¿™ä¸ªåœºæ™¯åˆ‡æ¢é—®é¢˜ï¼š
```
    func showThemeVC(_ model: ThemeModel) {
        if model.id == nil {
            bindtoNav?.selectedIndex = 0
        } else {
            bindtoNav?.selectedIndex = 1
        }
    }
```
å¦‚æœä½ æœ‰æ›´å¥½çš„åˆ‡æ¢æ–¹æ³•è¯·è”ç³»æˆ‘ï¼Œæ„¿æ„è¯·ä½ å–å’–å•¡ğŸ˜­

####2. æ–‡ç« çš„å¿«é€Ÿåˆ‡æ¢

![newsChange.gif](https://github.com/kLike/ZhiHu-RxSwift/blob/master/ZhiHu%2BRxSwift/newsChange.gif)

æ–‡ç« è¯¦æƒ…æ˜¯ç”¨UIWebViewåŠ è½½htmlæ•°æ®æ¥å±•ç°çš„ï¼Œè¿™é‡Œæˆ‘è‡ªå®šä¹‰class DetailWebView: UIWebViewï¼Œä»¥ä¾¿äºä¸¤ä¸ªæ–‡ç« è¯¦æƒ…çš„åˆ‡æ¢ï¼Œç”¨äºæ˜¾ç¤ºæ–‡ç« è¯¦æƒ…çš„DetailViewControlleråŒ…å«ä¸¤ä¸ªDetailWebViewï¼Œä¸€ä¸ªwebviewç”¨äºå±•ç¤ºå½“å‰é¡µé¢ï¼Œå¦ä¸€ä¸ªpreviousWebæ”¾åœ¨å±å¹•å¤–å‡†å¤‡éšæ—¶åˆ‡æ¢æ–‡ç« ï¼Œå½“å‘ç”Ÿåˆ‡æ¢æ–‡ç« æ—¶ï¼ŒåŠ¨ç”»å‘ˆç°previousWebï¼Œå¹¶åœ¨åç»­ç§»é™¤åœ¨å±å¹•å¤–webviewï¼ŒæŠŠpreviousWebä½œä¸ºæ–°çš„webviewï¼ŒåŒæ—¶ç”Ÿæˆæ–°çš„previousWeb
```
    //åˆ‡æ¢æ–‡ç« è¯¦æƒ…
    func scrollViewDidEndDragging(_ scrollView: UIScrollView, willDecelerate decelerate: Bool) {
        if scrollView.contentOffset.y <= -60 {
            if previousId > 0 {
                previousWeb.frame = CGRect.init(x: 0, y: -screenH, width: screenW, height: screenH)
                UIView.animate(withDuration: 0.3, animations: {
                    self.webview.transform = CGAffineTransform.init(translationX: 0, y: screenH)
                    self.previousWeb.transform = CGAffineTransform.init(translationX: 0, y: screenH)
                }, completion: { (state) in
                    if state { self.changeWebview(self.previousId) }
                })
            }
        }
        if scrollView.contentOffset.y - 50 + screenH >= scrollView.contentSize.height {
            if nextId > 0 {
                previousWeb.frame = CGRect.init(x: 0, y: screenH, width: screenW, height: screenH)
                UIView.animate(withDuration: 0.3, animations: {
                    self.previousWeb.transform = CGAffineTransform.init(translationX: 0, y: -screenH)
                    self.webview.transform = CGAffineTransform.init(translationX: 0, y: -screenH)
                }, completion: { (state) in
                    if state { self.changeWebview(self.nextId) }
                })
            }
        }
    }

    //åˆ‡æ¢ä¹‹ååç»­å¤„ç†
    func changeWebview(_ showID: Int) {
        webview.removeFromSuperview()
        previousWeb.scrollView.delegate = self
        previousWeb.delegate = self
        webview = previousWeb
        id = showID
        setUI()
        previousWeb = DetailWebView.init(frame: CGRect.init(x: 0, y: -screenH, width: screenW, height: screenH))
        view.addSubview(previousWeb)
        scrollViewDidScroll(webview.scrollView)
    }
```

####3.é¦–é¡µåˆ·æ–°
Swiftç‰ˆçš„åˆ·æ–°æ§ä»¶ä¸‰æ–¹è¿˜æ²¡æ‰¾æ¯”è¾ƒå¥½çš„ï¼Œä¸€åº¦æ‰“ç®—è‡ªå·±å°è£…ä¸€ä¸ªï¼Œä½†æ˜¯ä¸€ç›´æ‹–ç€ï¼ŒğŸ˜«ä»¥ååº”è¯¥ä¼šå†™ã€‚
çŸ¥ä¹æ—¥æŠ¥çš„åˆ·æ–°æ§ä»¶ä¸ä¸€èˆ¬æ”¾åœ¨tableviewä¸Šä¸åŒï¼Œå®ƒåº”è¯¥æ˜¯æ”¾åœ¨å¯¼èˆªæ ä¸Šé¢ï¼Œé…åˆtableviewæ¥å®ç°åˆ·æ–°ï¼Œè¿™ä¹Ÿæ˜¯å‰é¢ä¸ºä»€ä¹ˆè¯´å¯¼èˆªæ è¦è‡ªå®šä¹‰çš„åŸå› ä¹‹ä¸€ï¼Œå› ä¸ºå·²ç»ç”¨äº†åŸç”Ÿçš„å¯¼èˆªæ ï¼Œåªå¥½å·§å¦™ï¼ˆå·æ‡’ï¼‰åŠ åœ¨äº†viewä¸Šï¼Œå…¶å®è¿™ä¸ªåˆ·æ–°å°±æ˜¯ä¸€ä¸ªç”»åœ†åœˆçš„è¿‡ç¨‹ï¼Œä¸‹é¢çœ‹çœ‹è‡ªå®šä¹‰çš„RefreshView:
```
class RefreshView: UIView {

    let circleLayer = CAShapeLayer()

    let indicatorView = UIActivityIndicatorView().then {
        $0.frame = CGRect(x: 0, y: 0, width: 16, height: 16)
    }
    
    fileprivate var refreshing = false
    fileprivate var endRef = false
    
    override init(frame: CGRect) {
        super.init(frame: frame)
        creatCircleLayer()
    }
    
    override func layoutSubviews() {
        super.layoutSubviews()
        circleLayer.position = CGPoint(x: frame.width/2, y: frame.height/2)
        indicatorView.center = CGPoint(x: frame.width/2, y: frame.height/2)
    }
    
    func creatCircleLayer() {
        circleLayer.path = UIBezierPath(arcCenter: CGPoint(x: 8, y: 8),
                               radius: 8,
                               startAngle: CGFloat(M_PI_2),
                               endAngle: CGFloat(M_PI_2 + 2*M_PI),
                               clockwise: true).cgPath
        circleLayer.strokeColor = UIColor.white.cgColor
        circleLayer.fillColor = UIColor.clear.cgColor
        circleLayer.strokeStart = 0.0
        circleLayer.strokeEnd = 0.0
        circleLayer.lineWidth = 1.0
        circleLayer.lineCap = kCALineCapRound
        circleLayer.bounds = CGRect(x: 0, y: 0, width: 16, height: 16)
        circleLayer.anchorPoint = CGPoint(x: 0.5, y: 0.5)
        layer.addSublayer(circleLayer)
    }
    
    required init?(coder aDecoder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }

}

extension RefreshView {
    //å‘ä¸‹æ‹–æ‹½è§†å›¾å‡†å¤‡åˆ·æ–°çš„è¿‡ç¨‹ä¼šå“åº”
    func pullToRefresh(progress: CGFloat) {
        circleLayer.strokeEnd = progress
    }
    //å¼€å§‹åˆ·æ–°
    func beginRefresh(begin: @escaping () -> Void) {
        if refreshing {
            //é˜²æ­¢åˆ·æ–°æœªç»“æŸåˆå¼€å§‹è¯·æ±‚åˆ·æ–°
            return
        }
        refreshing = true
        circleLayer.removeFromSuperlayer()
        addSubview(indicatorView)
        indicatorView.startAnimating()
        begin()
    }
    //ç»“æŸåˆ·æ–°
    func endRefresh() {
        refreshing = false
        indicatorView.stopAnimating()
        indicatorView.removeFromSuperview()
    }
    //é‡åˆ¶åˆ·æ–°æ§ä»¶
    func resetLayer() {
        DispatchQueue.main.asyncAfter(deadline: DispatchTime.now() + 0.5) {
            self.creatCircleLayer()
        }
    }
    
}
```
###æ³¨æ„äº‹é¡¹
- é¡¹ç›®ä¸­å…³äºæ—¶é—´çš„å¤„ç†ç”¨çš„æ˜¯ [SwiftDate](https://github.com/malcommac/SwiftDate)
- .then è¯­æ³•ç”¨çš„æ˜¯ [Then](https://github.com/devxoul/Then)ï¼Œå°è€Œå¦™ï¼Œå¾ˆå–œæ¬¢

###æ€»ç»“
å°ç”Ÿæ‰ç–å­¦æµ…ï¼Œæœªæœ‰ç¼–ç¨‹å¤©èµ‹ï¼Œéš¾å…æœ‰è®¸å¤šè°¬è¯¯çº°æ¼ä¹‹å¤„ï¼Œå„ä½çœ‹å®˜å½“çœ‹ä¸”çœ‹ï¼Œè‹¥æœ‰ä»»ä½•é—®é¢˜éƒ½å¯ä»¥æå‡ºï¼Œæ„¿æ¥å—å„ç§æ‰¹è¯„å»ºè®®ã€‚è¦æ˜¯è§‰å¾—è¿™ç¯‡æ–‡ç« ç¨æœ‰ç”¨å¤„ï¼Œå¯ä»¥ç»™ä¸ªstarï¼Œååˆ†æ„Ÿæ¿€ã€‚
